name: Release Sandbox Compute Image

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Version bump
        type: choice
        options:
          - major
          - minor
          - patch
        required: true
      notes:
        description: Patch notes
        type: string
        required: false
      title:
        description: Release title
        type: string
        required: false

concurrency:
  group: sandbox-compute-server-release
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

env:
  IMAGE_NAME: ghcr.io/gobii-ai/gobii-sandbox-compute

jobs:
  release:
    name: Release Sandbox Compute Server Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Bump version
        env:
          BUMP: ${{ inputs.bump }}
        run: |
          python - <<'PY'
          import os
          import re
          import sys
          import tomllib

          bump = os.environ["BUMP"]
          path = "pyproject.toml"
          text = open(path, "r", encoding="utf-8").read()
          try:
              data = tomllib.loads(text)
          except tomllib.TOMLDecodeError as exc:
              print(f"Invalid pyproject.toml: {exc}", file=sys.stderr)
              sys.exit(1)

          version = (data.get("project") or {}).get("version")
          if not isinstance(version, str) or not version.strip():
              print("Version not found in pyproject.toml [project].version", file=sys.stderr)
              sys.exit(1)

          match = re.match(r'^(?P<maj>\d+)\.(?P<min>\d+)\.(?P<pat>\d+)$', version.strip())
          if not match:
              print(f"Unsupported version format: {version}", file=sys.stderr)
              sys.exit(1)

          major = int(match.group("maj"))
          minor = int(match.group("min"))
          patch = int(match.group("pat"))

          if bump == "major":
              major += 1
              minor = 0
              patch = 0
          elif bump == "minor":
              minor += 1
              patch = 0
          elif bump == "patch":
              patch += 1
          else:
              print(f"Unsupported bump: {bump}", file=sys.stderr)
              sys.exit(1)

          new_version = f"{major}.{minor}.{patch}"
          pattern = r'(?m)^(version\\s*=\\s*")' + re.escape(version.strip()) + r'("\\s*(#.*)?)$'
          def _replace(match: re.Match) -> str:
              return f'{match.group(1)}{new_version}{match.group(2)}'

          updated, count = re.subn(
              pattern,
              _replace,
              text,
              count=1,
          )
          if updated == text:
              print("Version update failed: version line not replaced", file=sys.stderr)
              sys.exit(1)
          open(path, "w", encoding="utf-8").write(updated)
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env:
              env.write(f"NEW_VERSION={new_version}\\n")
          print(f"Bumped version to {new_version}")
          PY

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "chore(release): ${NEW_VERSION}"
          git tag -a "${NEW_VERSION}" -m "Release ${NEW_VERSION}"

      - name: Push release commit and tag
        run: |
          git push origin HEAD:main
          git push origin --tags

      - name: Generate release notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api "repos/${{ github.repository }}/releases/generate-notes" \
            -f tag_name="${NEW_VERSION}" \
            --jq .body > release-notes-auto.md

      - name: Set release SHAs
        run: |
          echo "GIT_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"
          echo "SHORT_SHA=$(git rev-parse --short=7 HEAD)" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push release image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:main
            ${{ env.IMAGE_NAME }}:${{ env.NEW_VERSION }}
            ${{ env.IMAGE_NAME }}:sha-${{ env.GIT_SHA }}
            ${{ env.IMAGE_NAME }}:sha-${{ env.SHORT_SHA }}
          build-args: |
            GIT_COMMIT=${{ env.GIT_SHA }}
          cache-from: type=gha,scope=gobii-sandbox-compute
          cache-to: type=gha,mode=max,scope=gobii-sandbox-compute
          platforms: linux/amd64
          provenance: false
          sbom: false

      - name: Assemble release notes file
        env:
          NOTES: ${{ inputs.notes }}
          TITLE: ${{ inputs.title }}
          VERSION: ${{ env.NEW_VERSION }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          version = os.environ.get("VERSION", "").strip()
          title = os.environ.get("TITLE", "").strip()
          notes = os.environ.get("NOTES", "").strip()

          parts = []
          if version:
            header = f"## {version}" + (f" - {title}" if title else "")
            parts.append(header)
          if notes:
            parts.extend(["", notes])

          auto_path = Path("release-notes-auto.md")
          if auto_path.exists():
            auto_notes = auto_path.read_text(encoding="utf-8").strip()
            if auto_notes:
              parts.extend(["", auto_notes])

          content = "\n".join(part for part in parts if part is not None).lstrip()
          if content and not content.endswith("\n"):
            content += "\n"
          Path("release-notes.md").write_text(content, encoding="utf-8")
          PY

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${NEW_VERSION}" \
            --title "${NEW_VERSION}" \
            --notes-file release-notes.md
